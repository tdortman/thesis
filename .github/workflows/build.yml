name: Build and Deploy Thesis PDF

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    container:
      image: texlive/texlive
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Get project properties
        id: properties
        run: |
          COMMIT_DATE=$(date -d "${{ github.event.head_commit.timestamp }}" +%Y%m%d 2>/dev/null || date +%Y%m%d)
          PROJECT_TITLE="thesis"
          FILE_NAME="${COMMIT_DATE}_${PROJECT_TITLE}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT

          echo "Commit Date: $COMMIT_DATE"
          echo "Short SHA: $SHORT_SHA"
          echo "File Name: $FILE_NAME"

      - name: Build PDF
        run: |
          export TERM=xterm
          # First run of pdflatex
          pdflatex -jobname=my-thesis -shell-escape -interaction=nonstopmode "\def\thesisVersion{${{ steps.properties.outputs.short_sha }}}\input{my-thesis.tex}" || true

          # Run biber for bibliography
          biber my-thesis || true

          # Second run of pdflatex for references
          pdflatex -jobname=my-thesis -interaction=nonstopmode "\def\thesisVersion{${{ steps.properties.outputs.short_sha }}}\input{my-thesis.tex}" || true

          # Third run of pdflatex for final references
          pdflatex -jobname=my-thesis -interaction=nonstopmode "\def\thesisVersion{${{ steps.properties.outputs.short_sha }}}\input{my-thesis.tex}" || true

          # Rename PDF with dated filename
          mv my-thesis.pdf "${{ steps.properties.outputs.file_name }}.pdf"

      - name: Prepare Pages artifacts
        run: |
          mkdir -p _site
          cp "${{ steps.properties.outputs.file_name }}.pdf" _site/thesis.pdf

          # Create index.html with embedded PDF viewer
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=thesis.pdf">
              <title>Thesis PDF</title>
          </head>
          <body>
              <p>Redirecting to <a href="thesis.pdf">thesis.pdf</a>...</p>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build-pdf
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
